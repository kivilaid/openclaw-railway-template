<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OpenClaw Dashboard</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/css/xterm.css" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #0d1117; --card: #161b22; --border: #30363d; --accent: #58a6ff;
      --text: #c9d1d9; --text-muted: #8b949e; --green: #3fb950; --red: #f85149;
      --yellow: #d29922; --blue: #58a6ff; --sidebar-w: 220px;
    }
    html, body { height: 100%; background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif; font-size: 14px; }
    
    /* Layout */
    .app { display: flex; height: 100vh; }
    .sidebar { width: var(--sidebar-w); background: var(--card); border-right: 1px solid var(--border); display: flex; flex-direction: column; flex-shrink: 0; overflow-y: auto; }
    .sidebar-header { padding: 16px; border-bottom: 1px solid var(--border); }
    .sidebar-header h1 { font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
    .sidebar-header .status-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
    .sidebar-header .status-dot.running { background: var(--green); box-shadow: 0 0 6px var(--green); }
    .sidebar-header .status-dot.stopped { background: var(--red); box-shadow: 0 0 6px var(--red); }
    .sidebar-header .status-dot.unknown { background: var(--yellow); }
    .sidebar-header .uptime { font-size: 11px; color: var(--text-muted); margin-top: 4px; }
    .sidebar nav { flex: 1; padding: 8px 0; }
    .sidebar nav a { display: flex; align-items: center; gap: 8px; padding: 8px 16px; color: var(--text-muted); text-decoration: none; font-size: 13px; cursor: pointer; border-left: 3px solid transparent; transition: all .15s; }
    .sidebar nav a:hover { color: var(--text); background: rgba(88,166,255,0.06); }
    .sidebar nav a.active { color: var(--accent); border-left-color: var(--accent); background: rgba(88,166,255,0.1); }
    .sidebar nav a .icon { width: 18px; text-align: center; }
    
    .main { flex: 1; overflow-y: auto; padding: 24px; min-width: 0; }
    .section { display: none; }
    .section.active { display: block; }
    
    /* Cards */
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 16px; }
    .card h2 { font-size: 15px; font-weight: 600; margin-bottom: 12px; color: var(--text); }
    .card h3 { font-size: 13px; font-weight: 600; margin-bottom: 8px; color: var(--text-muted); }
    
    /* Stats row */
    .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 16px; }
    .stat-card { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 14px; text-align: center; }
    .stat-card .value { font-size: 24px; font-weight: 700; color: var(--accent); }
    .stat-card .label { font-size: 11px; color: var(--text-muted); margin-top: 4px; text-transform: uppercase; letter-spacing: .5px; }
    
    /* Buttons */
    .btn { display: inline-flex; align-items: center; gap: 6px; padding: 7px 14px; border: 1px solid var(--border); border-radius: 6px; background: var(--card); color: var(--text); font-size: 13px; cursor: pointer; transition: all .15s; }
    .btn:hover { border-color: var(--accent); color: var(--accent); }
    .btn.primary { background: var(--accent); color: #fff; border-color: var(--accent); }
    .btn.primary:hover { background: #4c94e8; }
    .btn.danger { border-color: var(--red); color: var(--red); }
    .btn.danger:hover { background: rgba(248,81,73,0.15); }
    .btn.success { border-color: var(--green); color: var(--green); }
    .btn.success:hover { background: rgba(63,185,80,0.15); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-group { display: flex; gap: 8px; flex-wrap: wrap; }
    
    /* Log viewer */
    .log-viewer { background: #010409; border: 1px solid var(--border); border-radius: 6px; font-family: 'SF Mono', SFMono-Regular, Consolas, 'Liberation Mono', Menlo, monospace; font-size: 12px; line-height: 1.6; padding: 12px; max-height: 400px; overflow-y: auto; white-space: pre-wrap; word-break: break-all; }
    .log-line { }
    .log-line.error { color: var(--red); }
    .log-line.started, .log-line.success { color: var(--green); }
    .log-line.message { color: var(--blue); }
    .log-line.channel { color: var(--yellow); }
    
    /* Table */
    .data-table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .data-table th { text-align: left; padding: 8px 12px; border-bottom: 1px solid var(--border); color: var(--text-muted); font-weight: 600; font-size: 11px; text-transform: uppercase; letter-spacing: .5px; }
    .data-table td { padding: 8px 12px; border-bottom: 1px solid rgba(48,54,61,0.5); }
    
    /* Input */
    .input { background: #010409; border: 1px solid var(--border); border-radius: 6px; color: var(--text); padding: 7px 12px; font-size: 13px; width: 100%; outline: none; font-family: inherit; }
    .input:focus { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(88,166,255,0.2); }
    .input-group { display: flex; gap: 8px; }
    .input-group .input { flex: 1; }
    
    /* Badge */
    .badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; }
    .badge.pass { background: rgba(63,185,80,0.15); color: var(--green); }
    .badge.warn { background: rgba(210,153,34,0.15); color: var(--yellow); }
    .badge.fail { background: rgba(248,81,73,0.15); color: var(--red); }
    
    /* Terminal */
    #terminal-container { height: 450px; border: 1px solid var(--border); border-radius: 6px; overflow: hidden; }
    
    /* Search results */
    .search-result { border-bottom: 1px solid var(--border); padding: 10px 0; }
    .search-result:last-child { border-bottom: none; }
    .search-result .file { color: var(--accent); font-size: 12px; font-weight: 600; }
    .search-result .match { font-family: monospace; font-size: 12px; margin-top: 4px; color: var(--text-muted); }
    .search-result .match mark { background: rgba(88,166,255,0.25); color: var(--accent); border-radius: 2px; }
    
    /* Version */
    .version-info { display: flex; align-items: center; gap: 12px; }
    .version-info .current { font-size: 18px; font-weight: 700; }
    .version-info .latest { font-size: 13px; color: var(--text-muted); }
    .version-info .up-to-date { color: var(--green); }
    .version-info .outdated { color: var(--yellow); }
    
    /* Upload area */
    .upload-area { border: 2px dashed var(--border); border-radius: 8px; padding: 24px; text-align: center; color: var(--text-muted); cursor: pointer; transition: all .15s; }
    .upload-area:hover { border-color: var(--accent); color: var(--accent); }
    .upload-area.dragover { border-color: var(--accent); background: rgba(88,166,255,0.06); }
    .upload-area input { display: none; }
    
    /* Audit results */
    .audit-results { max-height: 400px; overflow-y: auto; }
    .audit-line { padding: 4px 0; font-family: monospace; font-size: 12px; }
    .audit-line.pass { color: var(--green); }
    .audit-line.warn { color: var(--yellow); }
    .audit-line.fail { color: var(--red); }
    
    /* Responsive */
    @media (max-width: 768px) {
      .sidebar { width: 56px; }
      .sidebar nav a span.label { display: none; }
      .sidebar-header h1 span { display: none; }
      .sidebar-header .uptime { display: none; }
      .stats-row { grid-template-columns: repeat(2, 1fr); }
    }
    
    /* Loading spinner */
    .spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin .6s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-overlay { display: flex; align-items: center; justify-content: center; padding: 40px; color: var(--text-muted); gap: 8px; }
    
    /* Chart container */
    .chart-container { position: relative; height: 250px; }
  </style>
</head>
<body>
  <div class="app">
    <div class="sidebar">
      <div class="sidebar-header">
        <h1><span class="status-dot unknown" id="hdr-status-dot"></span><span>OpenClaw</span></h1>
        <div class="uptime" id="hdr-uptime">‚Äî</div>
      </div>
      <nav>
        <a data-section="overview" class="active"><span class="icon">üìä</span><span class="label">Overview</span></a>
        <a data-section="logs"><span class="icon">üìú</span><span class="label">Activity Log</span></a>
        <a data-section="usage"><span class="icon">üìà</span><span class="label">Token Usage</span></a>
        <a data-section="memory"><span class="icon">üß†</span><span class="label">Memory</span></a>
        <a data-section="cron"><span class="icon">‚è∞</span><span class="label">Cron Jobs</span></a>
        <a data-section="security"><span class="icon">üõ°Ô∏è</span><span class="label">Security</span></a>
        <a data-section="system"><span class="icon">‚öôÔ∏è</span><span class="label">System</span></a>
        <a data-section="terminal"><span class="icon">üíª</span><span class="label">Terminal</span></a>
      </nav>
    </div>
    <div class="main">
      
      <!-- Overview -->
      <div class="section active" id="sec-overview">
        <div class="card">
          <h2>Gateway Controls</h2>
          <div class="btn-group">
            <button class="btn success" onclick="gwAction('start')">‚ñ∂ Start</button>
            <button class="btn" onclick="gwAction('stop')">‚èπ Stop</button>
            <button class="btn" onclick="gwAction('restart')">üîÑ Restart</button>
          </div>
        </div>
        <div class="stats-row" id="stats-row">
          <div class="stat-card"><div class="value" id="stat-skills">‚Äî</div><div class="label">Skills</div></div>
          <div class="stat-card"><div class="value" id="stat-sessions">‚Äî</div><div class="label">Sessions</div></div>
          <div class="stat-card"><div class="value" id="stat-version">‚Äî</div><div class="label">Version</div></div>
          <div class="stat-card"><div class="value" id="stat-model">‚Äî</div><div class="label">Model</div></div>
        </div>
      </div>
      
      <!-- Activity Log -->
      <div class="section" id="sec-logs">
        <div class="card">
          <h2>Activity Log</h2>
          <div class="log-viewer" id="log-viewer"></div>
        </div>
      </div>
      
      <!-- Token Usage -->
      <div class="section" id="sec-usage">
        <div class="card">
          <h2>Token Usage (7 days)</h2>
          <div class="chart-container"><canvas id="usage-chart"></canvas></div>
        </div>
      </div>
      
      <!-- Memory -->
      <div class="section" id="sec-memory">
        <div class="card">
          <h2>Memory</h2>
          <div class="stats-row">
            <div class="stat-card"><div class="value" id="mem-backend">‚Äî</div><div class="label">Backend</div></div>
            <div class="stat-card"><div class="value" id="mem-entries">‚Äî</div><div class="label">Entries</div></div>
            <div class="stat-card"><div class="value" id="mem-files">‚Äî</div><div class="label">Files</div></div>
          </div>
          <div class="input-group" style="margin-bottom:12px;">
            <input class="input" id="mem-search-input" placeholder="Search memory files..." />
            <button class="btn primary" onclick="searchMemory()">Search</button>
            <button class="btn" onclick="indexMemory()">Re-index</button>
          </div>
          <div id="mem-search-results"></div>
        </div>
      </div>
      
      <!-- Cron -->
      <div class="section" id="sec-cron">
        <div class="card">
          <h2>Scheduled Tasks</h2>
          <button class="btn" onclick="loadCron()" style="margin-bottom:12px;">üîÑ Refresh</button>
          <div id="cron-content"><div class="loading-overlay"><div class="spinner"></div> Loading...</div></div>
        </div>
      </div>
      
      <!-- Security -->
      <div class="section" id="sec-security">
        <div class="card">
          <h2>Security Audit</h2>
          <button class="btn primary" onclick="runAudit()" id="audit-btn">üõ°Ô∏è Run Audit</button>
          <div id="audit-results" class="audit-results" style="margin-top:12px;"></div>
        </div>
      </div>
      
      <!-- System -->
      <div class="section" id="sec-system">
        <div class="card">
          <h2>Version & Upgrade</h2>
          <div class="version-info" id="version-info">
            <span class="current" id="ver-current">‚Äî</span>
            <span class="latest" id="ver-latest"></span>
          </div>
          <div style="margin-top:12px;">
            <button class="btn primary" onclick="doUpgrade()" id="upgrade-btn">‚¨Ü Upgrade</button>
            <span id="upgrade-status" style="margin-left:8px;font-size:12px;color:var(--text-muted);"></span>
          </div>
        </div>
        <div class="card">
          <h2>Backup & Restore</h2>
          <div class="btn-group" style="margin-bottom:16px;">
            <a class="btn" href="/lite/api/backup" id="backup-link">üíæ Download Backup</a>
          </div>
          <div class="upload-area" id="restore-area" onclick="document.getElementById('restore-file').click()">
            <input type="file" id="restore-file" accept=".tar.gz,.tgz,.zip" onchange="doRestore(this.files[0])" />
            <p>üìÅ Click or drag a .tar.gz / .zip backup to restore</p>
          </div>
          <div id="restore-status" style="margin-top:8px;font-size:12px;"></div>
        </div>
      </div>
      
      <!-- Terminal -->
      <div class="section" id="sec-terminal">
        <div class="card">
          <h2>Terminal</h2>
          <div id="terminal-container"></div>
        </div>
      </div>
      
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/lib/xterm.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@xterm/addon-fit@0.10.0/lib/addon-fit.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    #login-overlay {
      position: fixed; inset: 0; background: var(--bg);
      display: flex; align-items: center; justify-content: center;
      z-index: 9999;
    }
    #login-overlay.hidden { display: none; }
    #login-box {
      background: var(--card); border: 1px solid var(--border);
      border-radius: 12px; padding: 32px; width: 320px; text-align: center;
    }
    #login-box h2 { font-size: 18px; margin-bottom: 8px; }
    #login-box p { color: var(--text-muted); font-size: 13px; margin-bottom: 20px; }
    #login-pwd {
      width: 100%; padding: 9px 12px; background: var(--bg);
      border: 1px solid var(--border); border-radius: 6px;
      color: var(--text); font-size: 14px; margin-bottom: 12px; outline: none;
    }
    #login-pwd:focus { border-color: var(--accent); }
    #login-btn {
      width: 100%; padding: 9px; background: var(--accent);
      border: none; border-radius: 6px; color: #000;
      font-size: 14px; font-weight: 600; cursor: pointer;
    }
    #login-btn:hover { opacity: .85; }
    #login-error { color: var(--red); font-size: 12px; margin-top: 10px; min-height: 16px; }
  </style>

  <div id="login-overlay">
    <div id="login-box">
      <h2>üîÆ OpenClaw Dashboard</h2>
      <p>Enter your SETUP_PASSWORD to continue</p>
      <input id="login-pwd" type="password" placeholder="Password" autocomplete="current-password" />
      <button id="login-btn">Sign in</button>
      <div id="login-error"></div>
    </div>
  </div>

  <script>
    // Auth
    const params = new URLSearchParams(location.search);
    let password = params.get('pwd') || sessionStorage.getItem('oc_pwd') || '';

    function authHeaders() {
      return { 'Authorization': 'Basic ' + btoa('admin:' + password) };
    }

    let loginResolve = null;
    function showLogin(errMsg) {
      document.getElementById('login-overlay').classList.remove('hidden');
      document.getElementById('login-error').textContent = errMsg || '';
      document.getElementById('login-pwd').value = '';
      document.getElementById('login-pwd').focus();
      return new Promise(r => { loginResolve = r; });
    }
    function hideLogin() {
      document.getElementById('login-overlay').classList.add('hidden');
    }

    document.getElementById('login-btn').addEventListener('click', async () => {
      const val = document.getElementById('login-pwd').value.trim();
      if (!val) return;
      password = val;
      // Test it
      const test = await fetch('/lite/api/status', { headers: authHeaders() });
      if (test.status === 401) {
        document.getElementById('login-error').textContent = 'Wrong password, try again.';
        return;
      }
      sessionStorage.setItem('oc_pwd', password);
      hideLogin();
      if (loginResolve) { loginResolve(); loginResolve = null; }
    });
    document.getElementById('login-pwd').addEventListener('keydown', e => {
      if (e.key === 'Enter') document.getElementById('login-btn').click();
    });

    async function apiFetch(url, opts = {}) {
      const headers = { ...authHeaders(), ...(opts.headers || {}) };
      const res = await fetch(url, { ...opts, headers });
      if (res.status === 401) {
        await showLogin('Session expired ‚Äî please sign in again.');
        return apiFetch(url, opts);
      }
      return res;
    }

    async function apiJson(url, opts) {
      const res = await apiFetch(url, opts);
      return res.json();
    }
    
    // Navigation
    document.querySelectorAll('.sidebar nav a').forEach(a => {
      a.addEventListener('click', () => {
        document.querySelectorAll('.sidebar nav a').forEach(x => x.classList.remove('active'));
        document.querySelectorAll('.section').forEach(x => x.classList.remove('active'));
        a.classList.add('active');
        const sec = document.getElementById('sec-' + a.dataset.section);
        if (sec) sec.classList.add('active');
        
        if (a.dataset.section === 'logs') startLogPolling();
        if (a.dataset.section === 'usage') loadUsage();
        if (a.dataset.section === 'memory') loadMemory();
        if (a.dataset.section === 'cron') loadCron();
        if (a.dataset.section === 'system') loadVersion();
        if (a.dataset.section === 'terminal') initTerminal();
      });
    });
    
    // ===== Status polling =====
    async function pollStatus() {
      try {
        const data = await apiJson('/lite/api/status');
        const dot = document.getElementById('hdr-status-dot');
        const uptime = document.getElementById('hdr-uptime');
        dot.className = 'status-dot ' + (data.running ? 'running' : 'stopped');
        uptime.textContent = data.running ? 'Up ' + formatUptime(data.uptime) : 'Stopped';
        
        if (data.model) document.getElementById('stat-model').textContent = data.model.split('/').pop() || data.model;
        if (data.channels) document.getElementById('stat-model').title = 'Channels: ' + data.channels.join(', ');
      } catch {}
    }
    
    function formatUptime(seconds) {
      if (!seconds) return '‚Äî';
      const d = Math.floor(seconds / 86400);
      const h = Math.floor((seconds % 86400) / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      if (d > 0) return d + 'd ' + h + 'h';
      if (h > 0) return h + 'h ' + m + 'm';
      return m + 'm';
    }
    
    // ===== Stats =====
    async function loadStats() {
      try {
        const data = await apiJson('/lite/api/stats');
        document.getElementById('stat-skills').textContent = data.skills ?? '‚Äî';
        document.getElementById('stat-sessions').textContent = data.sessions ?? '‚Äî';
        document.getElementById('stat-version').textContent = data.version ?? '‚Äî';
      } catch {}
    }
    
    // ===== Gateway Controls =====
    async function gwAction(action) {
      try {
        await apiFetch('/lite/api/gateway/' + action, { method: 'POST' });
        setTimeout(pollStatus, 1000);
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }
    
    // ===== Logs =====
    let logTimer = null;
    let lastLogTs = 0;
    
    function startLogPolling() {
      if (logTimer) return;
      loadLogs();
      logTimer = setInterval(loadLogs, 3000);
    }
    
    async function loadLogs() {
      try {
        const url = '/lite/api/logs' + (lastLogTs ? '?since=' + lastLogTs : '');
        const data = await apiJson(url);
        const viewer = document.getElementById('log-viewer');
        if (data.lines && data.lines.length > 0) {
          for (const line of data.lines) {
            const div = document.createElement('div');
            div.className = 'log-line ' + classifyLog(line.text || line);
            div.textContent = (line.ts ? new Date(line.ts).toLocaleTimeString() + ' ' : '') + (line.text || line);
            viewer.appendChild(div);
            if (line.ts) lastLogTs = Math.max(lastLogTs, line.ts);
          }
          // Keep max 500 lines
          while (viewer.children.length > 500) viewer.removeChild(viewer.firstChild);
          viewer.scrollTop = viewer.scrollHeight;
        }
      } catch {}
    }
    
    function classifyLog(text) {
      const t = (text || '').toLowerCase();
      if (t.includes('error') || t.includes('fatal') || t.includes('fail')) return 'error';
      if (t.includes('started') || t.includes('ready') || t.includes('listening')) return 'started';
      if (t.includes('message') || t.includes('session')) return 'message';
      if (t.includes('telegram') || t.includes('discord') || t.includes('channel')) return 'channel';
      return '';
    }
    
    // ===== Token Usage =====
    let usageChart = null;
    
    async function loadUsage() {
      try {
        const data = await apiJson('/lite/api/usage');
        const ctx = document.getElementById('usage-chart').getContext('2d');
        
        if (usageChart) usageChart.destroy();
        
        if (!data.days || data.days.length === 0) {
          // No data
          document.getElementById('usage-chart').parentElement.innerHTML = '<div class="loading-overlay">No usage data available</div>';
          return;
        }
        
        usageChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: data.days.map(d => d.date),
            datasets: [
              { label: 'Input tokens', data: data.days.map(d => d.input || 0), backgroundColor: '#58a6ff' },
              { label: 'Output tokens', data: data.days.map(d => d.output || 0), backgroundColor: '#3fb950' },
            ]
          },
          options: {
            responsive: true, maintainAspectRatio: false,
            scales: {
              x: { ticks: { color: '#8b949e' }, grid: { color: '#21262d' } },
              y: { ticks: { color: '#8b949e' }, grid: { color: '#21262d' } }
            },
            plugins: { legend: { labels: { color: '#c9d1d9' } } }
          }
        });
      } catch {}
    }
    
    // ===== Memory =====
    async function loadMemory() {
      try {
        const data = await apiJson('/lite/api/memory');
        document.getElementById('mem-backend').textContent = data.backend || 'file';
        document.getElementById('mem-entries').textContent = data.entries ?? '‚Äî';
        document.getElementById('mem-files').textContent = data.files ?? '‚Äî';
      } catch {}
    }
    
    async function searchMemory() {
      const q = document.getElementById('mem-search-input').value.trim();
      if (!q) return;
      const container = document.getElementById('mem-search-results');
      container.innerHTML = '<div class="loading-overlay"><div class="spinner"></div> Searching...</div>';
      try {
        const data = await apiJson('/lite/api/memory/search?q=' + encodeURIComponent(q));
        if (!data.results || data.results.length === 0) {
          container.innerHTML = '<div style="color:var(--text-muted);padding:12px;">No results found.</div>';
          return;
        }
        container.innerHTML = data.results.map(r => `
          <div class="search-result">
            <div class="file">${esc(r.file)}</div>
            <div class="match">${highlight(r.snippet, q)}</div>
          </div>
        `).join('');
      } catch (e) {
        container.innerHTML = '<div style="color:var(--red);">Error: ' + esc(e.message) + '</div>';
      }
    }
    
    async function indexMemory() {
      try {
        await apiFetch('/lite/api/memory/index', { method: 'POST' });
        loadMemory();
      } catch {}
    }
    
    // ===== Cron =====
    async function loadCron() {
      const container = document.getElementById('cron-content');
      container.innerHTML = '<div class="loading-overlay"><div class="spinner"></div> Loading...</div>';
      try {
        const data = await apiJson('/lite/api/cron');
        if (!data.tasks || data.tasks.length === 0) {
          container.innerHTML = '<div style="color:var(--text-muted);padding:12px;">No scheduled tasks.</div>';
          return;
        }
        container.innerHTML = '<table class="data-table"><thead><tr><th>Schedule</th><th>Command</th><th>Status</th></tr></thead><tbody>' +
          data.tasks.map(t => `<tr><td>${esc(t.schedule || t.cron || '‚Äî')}</td><td>${esc(t.command || t.name || '‚Äî')}</td><td>${esc(t.status || '‚Äî')}</td></tr>`).join('') +
          '</tbody></table>';
      } catch (e) {
        container.innerHTML = '<div style="color:var(--text-muted);padding:12px;">Unable to load cron tasks: ' + esc(e.message) + '</div>';
      }
    }
    
    // ===== Security Audit =====
    async function runAudit() {
      const btn = document.getElementById('audit-btn');
      const results = document.getElementById('audit-results');
      btn.disabled = true;
      results.innerHTML = '<div class="loading-overlay"><div class="spinner"></div> Running audit...</div>';
      try {
        const data = await apiJson('/lite/api/security-audit', { method: 'POST' });
        const lines = (data.output || '').split('\n').filter(Boolean);
        results.innerHTML = lines.map(l => {
          let cls = '';
          const ll = l.toLowerCase();
          if (ll.includes('‚úì') || ll.includes('pass') || ll.includes('ok')) cls = 'pass';
          else if (ll.includes('‚ö†') || ll.includes('warn')) cls = 'warn';
          else if (ll.includes('‚úó') || ll.includes('fail') || ll.includes('error')) cls = 'fail';
          return `<div class="audit-line ${cls}">${esc(l)}</div>`;
        }).join('');
      } catch (e) {
        results.innerHTML = '<div style="color:var(--red);">Error: ' + esc(e.message) + '</div>';
      }
      btn.disabled = false;
    }
    
    // ===== Version & Upgrade =====
    async function loadVersion() {
      try {
        const data = await apiJson('/lite/api/version');
        document.getElementById('ver-current').textContent = data.current || '‚Äî';
        const latestEl = document.getElementById('ver-latest');
        if (data.latest && data.latest !== data.current) {
          latestEl.textContent = '‚Üí ' + data.latest + ' available';
          latestEl.className = 'latest outdated';
        } else if (data.latest) {
          latestEl.textContent = '‚úì up to date';
          latestEl.className = 'latest up-to-date';
        }
      } catch {}
    }
    
    async function doUpgrade() {
      const btn = document.getElementById('upgrade-btn');
      const status = document.getElementById('upgrade-status');
      btn.disabled = true;
      status.textContent = 'Upgrading...';
      try {
        const data = await apiJson('/lite/api/upgrade', { method: 'POST' });
        status.textContent = data.ok ? '‚úì Upgrade complete! Restart recommended.' : '‚úó ' + (data.error || 'Upgrade failed');
        status.style.color = data.ok ? 'var(--green)' : 'var(--red)';
      } catch (e) {
        status.textContent = '‚úó ' + e.message;
        status.style.color = 'var(--red)';
      }
      btn.disabled = false;
    }
    
    // ===== Restore =====
    const restoreArea = document.getElementById('restore-area');
    restoreArea.addEventListener('dragover', e => { e.preventDefault(); restoreArea.classList.add('dragover'); });
    restoreArea.addEventListener('dragleave', () => restoreArea.classList.remove('dragover'));
    restoreArea.addEventListener('drop', e => {
      e.preventDefault();
      restoreArea.classList.remove('dragover');
      if (e.dataTransfer.files.length) doRestore(e.dataTransfer.files[0]);
    });
    
    async function doRestore(file) {
      if (!file) return;
      const status = document.getElementById('restore-status');
      status.textContent = 'Uploading ' + file.name + '...';
      status.style.color = 'var(--text-muted)';
      try {
        const form = new FormData();
        form.append('backup', file);
        const res = await apiFetch('/lite/api/restore', { method: 'POST', body: form });
        const data = await res.json();
        status.textContent = data.ok ? '‚úì Restore complete! Restart recommended.' : '‚úó ' + (data.error || 'Restore failed');
        status.style.color = data.ok ? 'var(--green)' : 'var(--red)';
      } catch (e) {
        status.textContent = '‚úó ' + e.message;
        status.style.color = 'var(--red)';
      }
    }
    
    // ===== Terminal =====
    let term = null;
    let termWs = null;
    let termInit = false;
    
    function initTerminal() {
      if (termInit) return;
      termInit = true;
      
      term = new Terminal({
        theme: { background: '#010409', foreground: '#c9d1d9', cursor: '#58a6ff', selectionBackground: '#264f78' },
        fontFamily: "'SF Mono', SFMono-Regular, Consolas, 'Liberation Mono', Menlo, monospace",
        fontSize: 13, cursorBlink: true
      });
      const fitAddon = new FitAddon.FitAddon();
      term.loadAddon(fitAddon);
      term.open(document.getElementById('terminal-container'));
      fitAddon.fit();
      
      const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
      const authProto = 'auth-' + btoa('admin:' + password);
      termWs = new WebSocket(proto + '//' + location.host + '/lite/ws', [authProto]);
      
      termWs.onopen = () => {
        termWs.send(JSON.stringify({ type: 'resize', cols: term.cols, rows: term.rows }));
      };
      
      termWs.onmessage = (e) => {
        term.write(typeof e.data === 'string' ? e.data : new Uint8Array(e.data));
      };
      
      termWs.onclose = () => {
        term.write('\r\n\x1b[31m[Session ended]\x1b[0m\r\n');
      };
      
      term.onData(data => {
        if (termWs && termWs.readyState === WebSocket.OPEN) {
          termWs.send(JSON.stringify({ type: 'input', data }));
        }
      });
      
      term.onResize(({ cols, rows }) => {
        if (termWs && termWs.readyState === WebSocket.OPEN) {
          termWs.send(JSON.stringify({ type: 'resize', cols, rows }));
        }
      });
      
      window.addEventListener('resize', () => fitAddon.fit());
    }
    
    // ===== Helpers =====
    function esc(s) { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }
    function highlight(text, query) {
      const e = esc(text);
      const re = new RegExp('(' + query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi');
      return e.replace(re, '<mark>$1</mark>');
    }
    
    // ===== Add auth to backup link =====
    document.getElementById('backup-link').addEventListener('click', function(e) {
      e.preventDefault();
      // Open with auth via a temporary form or just window.open with basic auth in URL
      const url = new URL('/lite/api/backup', location.origin);
      // Use XMLHttpRequest to download with auth
      const xhr = new XMLHttpRequest();
      xhr.open('GET', url.toString(), true);
      xhr.setRequestHeader('Authorization', 'Basic ' + btoa('admin:' + password));
      xhr.responseType = 'blob';
      xhr.onload = function() {
        if (xhr.status === 200) {
          const a = document.createElement('a');
          a.href = URL.createObjectURL(xhr.response);
          a.download = 'openclaw-backup-' + new Date().toISOString().replace(/[:.]/g, '-') + '.tar.gz';
          a.click();
          URL.revokeObjectURL(a.href);
        }
      };
      xhr.send();
    });
    
    // Init auth ‚Äî show login form if no password cached, else verify silently
    (async () => {
      if (!password) {
        await showLogin();
      } else {
        const test = await fetch('/lite/api/status', { headers: authHeaders() });
        if (test.status === 401) {
          password = '';
          sessionStorage.removeItem('oc_pwd');
          await showLogin('Session expired ‚Äî please sign in again.');
        } else {
          hideLogin();
        }
      }
      pollStatus();
      loadStats();
      setInterval(pollStatus, 10000);
    })();
    
    // Enter key on memory search
    document.getElementById('mem-search-input').addEventListener('keydown', e => {
      if (e.key === 'Enter') searchMemory();
    });
  </script>
</body>
</html>
